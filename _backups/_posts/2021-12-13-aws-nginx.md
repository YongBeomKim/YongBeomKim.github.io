---
title : AWS Django Nginx & Gunicorn 
last_modified_at: 2021-12-13T10:45:06-05:00
header:
   overlay_image: /assets/images/code/nginx-banner.png
categories:
  - nginx
tags: 
    - super
    - gunicorn
    - nginx
---

EC2 서버에 구체적인 모듈들을 설치 및 설정하는 내용들을 정리해 보았습니다. **[Minimal Nginx and Gunicorn configuration for Django projects](https://www.agiliq.com/blog/2013/08/minimal-nginx-and-gunicorn-configuration-for-djang/)** 를 참고하여 작성 하였습니다.

<br/>

# Nginx 

`django-ninja` 등의 Restful API 를 활용하면서 추가된 내용을 정리해 보겠습니다.

## 설치 및 설정

```r
$ sudo apt-get install nginx
$ sudo service nginx start
$ service nginx status
Active: active (running) since 28min ago
    └─716 nginx: /usr/sbin/nginx -g daemon on;

$ /etc/nginx » tree
  ├── sites-available
  │   └── default
  └── nginx.conf

$ nginx -s [ stop | quit | reopen | reload ] # 정지, 재가동
$ nginx -h        # Nginx 도움말
$ nginx -t        # Nginx 설정파일 유효성 검사
```

NGINX 의 설정 내용은 크게 2가지로 나눠 볼 수 있습니다. 
1. `nginx.conf` 인 Nginx 기본설정 파일 
2. `/etc/nginx/site-enable/` 폴더 내부의 서버 실행파일 

## nginx.conf

특별히 변경할 내용은 없습니다.

```r
$ cat vi /etc/nginx/nginx.conf

user www-data;
worker_processes auto;
include /etc/nginx/modules-enabled/*.conf;
```

## sites-available/default

Django 는 `127.0.0.1` 아이피, 포트를 Nginx 를 거치면서 외부 접속을 가능하게 합니다. Django 의 `Static` 과 `Media` 폴더는 Nginx 를 활용하여 연결 합니다. 추가 내용은 [`axios.post` 를 활용](https://stackoverflow.com/questions/50949594/axios-having-cors-issue) 하는 경우 [`OPTIONS` method](https://blog.huiya.me/12) 를 먼저 확인합니다. 따라서 서버단위에서 Options 설정을 추가를 해야 합니다. [CORS on Nginx](https://enable-cors.org/server_nginx.html) 내용을 참고 하였습니다.

```r
$ cat /etc/nginx/sites-available/default

server {
  listen 80;
  server_name arterior.kr;
  charset utf-8;

  location / {
    proxy_pass http://127.0.0.1:8000;
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
      add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';

      # Tell client that this pre-flight info is valid for 20 days
      add_header 'Access-Control-Max-Age' 1728000;
      add_header 'Content-Type' 'text/plain; charset=utf-8';
      add_header 'Content-Length' 0;
      return 204;
    }
    if ($request_method = 'POST') {
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
      add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
    }
  }
  location /static/ {
    autoindex on;
    alias /home/cobalt/Source/django/staticfiles/;
    expires 365d;
  }
  location /media/ {
    alias /home/cobalt/Source/media/;
    expires 365d;
  }  
}
```

<br/>

# Gunicorn & Uvicorn

## Uvicorn

[Django 공식문서](https://docs.djangoproject.com/en/4.0/howto/deployment/asgi/uvicorn/) 에서도 의 `127.0.0.1` 실행을 위한 미들웨어로 최신 모듈인 [Uvicorn](https://www.uvicorn.org/) 를 사용하고 있습니다. 별도 설정없이 자동으로 `127.0.0.1:8000` 주소로 실행됨을 로그로써 확인 가능합니다.

```r
$ gunicorn myproject.asgi:application -k uvicorn.workers.UvicornWorker
```

## gunicorn.service

스크립트를 자동으로 실행하도록 service deamon 을 활성화 해 보겠습니다. `User` 는 스크립트를 실행하는 User 의 이름을 추가 합니다. `Group` 이름은 Nginx 와 일치시킵니다.

```r
$ sudo vi /etc/systemd/system/gunicorn.service

[Unit]
Description=Service Title
After=network.target

[Service]
User=USERNAME
Group=www-data
WorkingDirectory=/home/USERNAME/django_code
Environment="PATH=/home/USERNAME/Python/venv/bin"
ExecStart=/home/USERNAME/Python/venv/bin/gunicorn myproject.asgi:application -k uvicorn.workers.UvicornWorker

[Install]
WantedBy=multi-user.target
```

service 파일을 정의했으면 daemon 과 연결하여 자동실행을 정의 합니다.

```r
$ sudo systemctl start gunicorn
$ sudo systemctl enable gunicorn
Created symlink /etc/systemd/system/multi-user.target.wants/gunicorn.service → /etc/systemd/system/gunicorn.service.

$ sudo systemctl status gunicorn
```